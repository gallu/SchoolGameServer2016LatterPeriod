# 2016年 後期 期末試験

試験の回答は、以下の通りにすること。

- １問あたり１ファイルに記述。ファイル名は「1-1.txt」でも「問1-1.txt」でも可。フォーマットはtext、拡張子は.txtとする
- 文字コードはUTF-8のすること

試験の注意事項は以下の通り

- 試験なので「周囲との相談」「他人の答案の覗き見」は不許可
- ネット等を使って調べるのは許可
- コードやSQLを勉強用サーバ(dev2.m-fr.net)で確認するのは推奨
- いずれの問題も「１問あたり５点」を満点とし、問題があったら適宜減点する

## 「特定のゲーム」のPC一人を入れられるテーブルを作成

「１ゲーム内の１プレイキャラクタ」の情報を格納できるCREATE TABLE文を作成しなさい。
カラム名は、日本語をそのまま使っても、適切な英語名にしてもよい、とします。
数値については、いずれも「負の値を持たない、65535以下」程度の値を想定しなさい。


### (問1-1) FF1のキャラクタ作成

FF1のプレイキャラクタ一人を格納できるテーブルを作成しなさい。
なお、パラメタは以下の通りとする。

- 名前
- HP
- 最大HP
- MP
- 最大MP
- 力
- 素早さ
- 知性
- 体力
- 幸運
- 所持金
- 経験値
- レベル

### (問1-2)GURPSのキャラクタ作成

GURPS BASICのプレイキャラクタ一人を格納できるテーブルを作成しなさい。
カラム名は、日本語をそのまま使っても、適切な英語名にしてもよい、とします。
なお、パラメタは以下の通りとする。

- 名前
- ST(体力)
- DX(敏捷力)
- IQ(知力)
- HT(生命力)
- 所持金
- 残CP

## 基本的なSQL構文

以下のテーブルに対して、適切なデータを取得できるSQL文を書きなさい。

```
CREATE TABLE exam (
  id int unsigned NOT NULL AUTO_INCREMENT,
  num int,
  name varchar(128),
  created datetime,
  PRIMARY KEY(id)
);
```

### (問2-1)select文：テーブル全部

examテーブルの「全てのレコード」を取得するSQLを書きなさい。

### (問2-2)select文：WHERE句

examテーブルのうち「idが10のレコード」を取得するSQLを書きなさい。

### (問2-3)select文：BETWEEN

examテーブルのうち「numが10以上100以下のレコード」を取得するSQLを書きなさい。

### (問2-4)select文：LIKE句

examテーブルのうち「nameに、文字列'abc'が含まれるレコード」を取得するSQLを書きなさい。

### (問2-5)select文：ORDER BY, LIMIT

examテーブルの「0番目から5レコード」を取得するSQLを書きなさい。
ただし、データはcreatedカラムの情報で降順にソートされるようにしなさい。

## PHPでのDB接続

### (問3-1)PDOによる接続

PHPで、PDOクラスを使ってdatabaseに接続するプログラムを書きなさい。
接続情報は以下の通りとする。

- 接続ID: test
- 接続パスワード: pass
- 接続database: database
- 接続サーバ: 192.168.0.1
- 文字コード: utf8mb4

### (問3-2)PDOによるSQL発行(INSERT)

問2に出てきたテーブルに１レコード追加するPHPプログラムを書きなさい。
データは任意とする。

## パスワードを含むユーザ情報の登録

### (問4-1)認証情報の登録

$idに「ユーザID」、$passに「ユーザから入力されたパスワードが入っている」前提で、DBに「適切な形で」データをinsertするPHPプログラムを書きなさい。
なお、PHPのバージョンは5.5以降である、とします。
また、insertするテーブルフォーマットは以下の通りとする。

```
CREATE TABLE user_auth (
  id varbinary(64) NOT NULL,
  password varbinary(64) NOT NULL,
  PRIMARY KEY(id)
);
```

### (問4-2)パスワードの比較

$passに「ユーザから入力されたパスワード」、$db_passに「password_hash()でハッシュされた、DBに格納されているパスワード情報」が入っている前提で、両者を比較するコードを書きなさい。
比較後、OKなら「認証OK」、NGなら「認証NG」と出力しなさい。

## 簡単な乱数の作成

### (問5-1)乱数の作成

PHPで「１から６までの間の乱数」を作成し、出力するコードを書きなさい。

### (問5-2)「乱数を取得する関数」の作成

PHPで「１から６までの間の乱数」を作成し、戻り値として返す関数を書きなさい。
関数名は「dice_6」とします。

### (問5-3)文字列を使った乱数の作成

以下の文字列が解釈可能なコードを書きなさい。
なお、表記は「振るダイスの数」D「ダイスのタイプ」とします。
例えば1D6の場合は「１回」「６面ダイス」を振る、となります。
例えば3D8の場合は「３回」「８面ダイス」を振る、となります。

- 1D6
- 2D6
- 3D8

### (問5-4)文字列を使った乱数の作成(難問)

以下の文字列が解釈可能なコードを書きなさい。
なお「計算結果が負の値になる」場合、そのまま負の値をreturnしなさい。

- 2D6+2
- 3D8+5
- 1D10+2d6-1d4-2

## トランザクション

### (問6-1)トランザクションを使うSQL文の作成：有料がちゃ

有料課金がちゃを引くために必要なSQLを、トランザクションを使って適切に書きなさい。
また、カードを引く前に「有料課金の残高が足りているかどうか」をSQLで確認しなさい。

- user_idは2016とする
- userテーブルの残高(money)を取得：PHPプログラムであればif文等でチェック。今回はSQLのみなのでチェック処理はオミット
- userテーブルのmoneyの値を100、減算
- user_cardテーブルにinsert。引いたカードID(card_id)は114とする

```
CREATE TABLE user (
  user_id int unsigned NOT NULL,
  money int unsigned ,
  PRIMARY KEY(user_id)
);
```

```
CREATE TABLE user_card (
  user_card_id int unsigned NOT NULL AUTO_INCREMENT,
  user_id int unsigned NOT NULL,
  card_id int unsigned NOT NULL,
  created datetime,
  PRIMARY KEY(user_card_id)
);
```

### (問6-2)トランザクションを使うSQL文の作成：有料アイテムの使用

有料アイテムを使うために必要なSQLを、トランザクションを使って適切に書きなさい。
また、アイテムを使う前に「アイテムの個数が足りているかどうか」をSQLで確認しなさい。

- user_idは2016とする
- 使うアイテムのitem_idは14とする
- card_idテーブルのアイテム個数(item_num)を取得：PHPプログラムであればif文等でチェック。今回はSQLのみなのでチェック処理はオミット
- item_numテーブルのitem_numの値をデクリメント(マイナス１する)

```
CREATE TABLE user_item (
  user_id int unsigned NOT NULL,
  item_id int unsigned NOT NULL,
  item_num int unsigned NOT NULL,
  PRIMARY KEY(user_id, item_id)
);
```

## アイテム使用

前提となるPCクラスは以下とする。
なお、setterとgetterは省略しているが、記述されているものとする(メソッド名はスネークでもキャメルでもどちらでもよい)。

```
class PC {
// 各プロパティへのsetterとgetter(省略

//private:
private $max_hp_;
private $max_mp_;
private $hp_;
private $mp_;
private $exp_; // 経験値
};
```

### (問7-1)プログラム型のアイテム使用(難問)

以下の5種類のアイテムを「プログラム型」で実装せよ。
なお、実装する関数は以下の関数名、引数を取るものとする。「入力値のエラー」は考慮しなくてよい。

```
function item_use($PCインスタンス, $アイテムID);
```

- HPを100点回復するアイテム(アイテムID: 1)
- MPを50点回復するアイテム(アイテムID: 2)
- HPを50%回復するアイテム(アイテムID: 3)
- HPを50%, MPを50%回復するアイテム(アイテムID: 4)
- 経験値が+1000されるアイテム(アイテムID: 5)


### (問7-2)マクロ型のアイテム使用(難問)

以下の5種類のアイテムを「マクロ型」で実装せよ。
マクロ文字列は任意とする(「明らかに汎用性がない」文字列は減点対象となるので注意)。
なお、実装する関数は以下の関数名、引数を取るものとする。「入力値のエラー」は考慮しなくてよい。

```
function item_use($PCインスタンス, $マクロ文字列);
```

- HPを100点回復するアイテム
- MPを50点回復するアイテム
- HPを50%回復するアイテム
- HPを50%, MPを50%回復するアイテム
- 経験値が+1000されるアイテム(アイテムID: 5)

## ゲームの感想

### (問8-1)ゲームの感想２種

授業でやったボードゲーム「メディチ」「モノポリー」「ドミニオン」から１つ選び、感想を書きなさい。
或いは、最近やっているゲームから１つ選び、それを勧める文章を書きなさい。

## サーバへのログインとファイルの作成

### (問9-1)サーバへのログインとファイル作成

dev2.m-fr.net サーバにログインし、自分のカレントディレクトリ(WinSCPだと、ホームのボタンで移動できます)に「final_exam.txt」という名前のファイルを作成しなさい。
ファイルの中身はなんでもよい、とします(空でもよいのですが、そのままだとWinSCPで保存が面倒なので、改行コードを１つ２つ入れるとよい)。

回答には「自分のアカウント名」を記述しなさい(アカウント名が不明だとチェックができないので、採点対象にならなくなります)。
